name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies and build
      run: |
        npm install
        npm run build

    - name: Create dist archive
      run: |
        cd dist
        zip -r ../cloudflare-email-routing-dist.zip .
        cd ..

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-files
        path: dist/
        retention-days: 30

    - name: Generate release tag
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      id: tag
      run: |
        echo "tag=v$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Cloudflare Email Routing ${{ steps.tag.outputs.tag }}
        body: |
          ## ğŸš€ Cloudflare é‚®ä»¶è·¯ç”±ç®¡ç†ç³»ç»Ÿ

          ### ğŸ“¦ éƒ¨ç½²æ–‡ä»¶
          ä¸‹è½½ `cloudflare-email-routing-dist.zip` æ–‡ä»¶ï¼Œè§£å‹åä¸Šä¼ åˆ°ä½ çš„æœåŠ¡å™¨å³å¯ã€‚

          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - å®Œæ•´çš„å‰ç«¯ React åº”ç”¨
          - ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
          - é‚®ä»¶è½¬å‘è§„åˆ™ç®¡ç†
          - ç®¡ç†å‘˜åå°ç³»ç»Ÿ
          - å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒç§»åŠ¨ç«¯

          ### ğŸ”§ éƒ¨ç½²è¯´æ˜
          1. ä¸‹è½½å¹¶è§£å‹ `cloudflare-email-routing-dist.zip`
          2. å°†è§£å‹åçš„æ–‡ä»¶ä¸Šä¼ åˆ°ä½ çš„ Web æœåŠ¡å™¨
          3. ç¡®ä¿æœåŠ¡å™¨æ”¯æŒ SPA è·¯ç”±ï¼ˆé…ç½® fallback åˆ° index.htmlï¼‰
          4. è®¿é—®ä½ çš„åŸŸåå³å¯ä½¿ç”¨

          ---
          æ„å»ºæ—¶é—´: ${{ steps.tag.outputs.tag }}
        files: |
          cloudflare-email-routing-dist.zip
        draft: false
        prerelease: false
